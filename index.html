<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ØµØ±ÙˆÙØ§ØªÙŠ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root { --bg:#0b1220; --card:#111b2e; --text:#e6edf6; --muted:#9fb2c7; --accent:#4ea0ff; --ok:#10b981; --bad:#ef4444; }
    .theme-ocean { --bg:#06141f; --card:#0b2536; --text:#e2f3ff; --muted:#94b8d6; --accent:#2ec5ff; }
    .theme-mint  { --bg:#061a14; --card:#0b2e24; --text:#e2fff6; --muted:#9ad4c2; --accent:#2ee6a6; }
    .theme-neon  { --bg:#0a0a0f; --card:#121225; --text:#f1f1ff; --muted:#a6a6ff; --accent:#7c3aed; }
    .theme-rose  { --bg:#1a0d14; --card:#2b1520; --text:#ffe9f0; --muted:#f0a8bf; --accent:#ff5c93; }

    body { background:var(--bg); color:var(--text); font-family:'Cairo', system-ui, sans-serif; }
    .card { background:linear-gradient(180deg, color-mix(in oklab, var(--card), black 5%), var(--card)); border:1px solid color-mix(in oklab, var(--card), white 6%); box-shadow:0 10px 30px rgba(0,0,0,.25); }
    .glow { box-shadow:0 0 0 rgba(0,0,0,0); transition: box-shadow .3s ease; }
    .glow:hover { box-shadow:0 0 24px color-mix(in oklab, var(--accent), white 10%); }
    .chip { background:color-mix(in oklab, var(--accent), black 80%); border:1px solid color-mix(in oklab, var(--accent), white 35%); }
    .tab { border-bottom:2px solid transparent; }
    .tab.active { border-color:var(--accent); color:var(--accent); }
    .btn { background:color-mix(in oklab, var(--accent), black 70%); border:1px solid color-mix(in oklab, var(--accent), white 35%); transition: transform .12s ease, filter .2s ease; }
    .btn:active { transform: translateY(1px) scale(.99); filter:brightness(.95); }
    .fab { position:fixed; inset-inline-end:16px; bottom:16px; display:flex; gap:12px; z-index:50; }
    .modal { position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.5); backdrop-filter: blur(6px); z-index:60; }
    .modal.active { display:grid; animation: fadeIn .15s ease; }
    @keyframes fadeIn { from{ opacity:0 } to { opacity:1 } }
    .animate-in { animation: pop .2s ease; }
    @keyframes pop { from{ transform:scale(.98); opacity:.9 } to{ transform:scale(1); opacity:1 } }

    .text-muted { color: var(--muted); }
    .text-ok    { color: var(--ok); }
    .text-bad   { color: var(--bad); }
  </style>
</head>
<body class="theme-ocean">
  <div class="max-w-5xl mx-auto px-3 sm:px-6 py-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Ù…ØµØ±ÙˆÙØ§ØªÙŠ</h1>
      <div class="flex items-center gap-2">
        <select id="themeSelect" class="chip rounded-xl px-3 py-2 text-sm">
          <option value="ocean">ğŸŒŠ Ocean</option>
          <option value="mint">ğŸŒ¿ Mint</option>
          <option value="neon">âš¡ï¸ Neon</option>
          <option value="rose">ğŸŒ¹ Rose</option>
        </select>
        <button id="refreshBtn" class="btn rounded-xl px-3 py-2 text-sm glow">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="flex gap-4 mb-4">
      <button class="tab active px-2 pb-2" data-tab="overview">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
      <button class="tab px-2 pb-2" data-tab="transactions">Ø§Ù„Ø­Ø±ÙƒØ§Øª</button>
      <button class="tab px-2 pb-2" data-tab="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </nav>

    <!-- Overview -->
    <section id="tab-overview" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="card rounded-2xl p-4 lg:col-span-2">
        <canvas id="pie"></canvas>
      </div>
      <div class="card rounded-2xl p-4 flex flex-col gap-3">
        <div class="flex items-center justify-between"><span class="text-muted">Ø§Ù„Ø±Ø§ØªØ¨/Ø§Ù„Ø¯Ø®Ù„</span><strong id="income" class="text-ok text-lg">0</strong></div>
        <div class="flex items-center justify-between"><span class="text-muted">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</span><strong id="expense" class="text-bad text-lg">0</strong></div>
        <div class="flex items-center justify-between"><span class="text-muted">Ø§Ù„Ø±ØµÙŠØ¯</span><strong id="balance" class="text-lg">0</strong></div>
        <div class="grid grid-cols-2 gap-2 pt-2 text-sm">
          <div class="chip rounded-xl px-3 py-2">Ø«Ø§Ø¨Øª: <b id="c-fixed">0</b></div>
          <div class="chip rounded-xl px-3 py-2">Ù…ØªØºÙŠØ±: <b id="c-variable">0</b></div>
          <div class="chip rounded-xl px-3 py-2">Ø§Ø¯Ø®Ø§Ø±: <b id="c-savings">0</b></div>
          <div class="chip rounded-xl px-3 py-2">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª: <b id="c-personal">0</b></div>
        </div>
      </div>
    </section>

    <!-- Transactions -->
    <section id="tab-transactions" class="hidden">
      <div class="card rounded-2xl p-4">
        <div id="txList" class="space-y-2 text-sm"></div>
      </div>
    </section>

    <!-- Settings -->
    <section id="tab-settings" class="hidden">
      <div class="card rounded-2xl p-4 space-y-4">
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="flex flex-col gap-1">
            <span class="text-muted text-sm">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</span>
            <input id="baseSalary" type="number" class="chip rounded-xl px-3 py-2 bg-transparent" placeholder="Ù…Ø«Ø§Ù„: 5000" />
          </label>
          <div class="flex items-end gap-2">
            <button id="applySuggest" class="btn rounded-xl px-3 py-2 glow">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‚ØªØ±Ø­</button>
            <button id="saveSettings" class="btn rounded-xl px-3 py-2 glow">Ø­ÙØ¸</button>
          </div>
        </div>

        <div class="grid sm:grid-cols-4 gap-3 text-sm">
          <label class="flex flex-col gap-1"><span class="text-muted">Ø«Ø§Ø¨Øª %</span><input id="alloc_fixed" type="number" min="0" max="100" class="chip rounded-xl px-3 py-2 bg-transparent"/></label>
          <label class="flex flex-col gap-1"><span class="text-muted">Ù…ØªØºÙŠØ± %</span><input id="alloc_variable" type="number" min="0" max="100" class="chip rounded-xl px-3 py-2 bg-transparent"/></label>
          <label class="flex flex-col gap-1"><span class="text-muted">Ø§Ø¯Ø®Ø§Ø± %</span><input id="alloc_savings" type="number" min="0" max="100" class="chip rounded-xl px-3 py-2 bg-transparent"/></label>
          <label class="flex flex-col gap-1"><span class="text-muted">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª %</span><input id="alloc_personal" type="number" min="0" max="100" class="chip rounded-xl px-3 py-2 bg-transparent"/></label>
        </div>

        <p class="text-xs text-muted">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù†Ø³Ø¨ Ø¥Ù† Ø£Ø±Ø¯ØªØŒ Ø£Ùˆ ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¹Ù„Ù‰ Ø­Ø³Ø¨ Ø§Ù„Ø±Ø§ØªØ¨ Ù„Ø¹Ø±Ø¶ Ø­Ø¯ÙˆØ¯ Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©.</p>
      </div>
    </section>

    <!-- FAB +/- -->
    <div class="fab">
      <button id="addIncome" class="btn glow rounded-full w-14 h-14 text-2xl">+</button>
      <button id="addExpense" class="btn glow rounded-full w-14 h-14 text-2xl">âˆ’</button>
    </div>

    <!-- Modal: Quick Add -->
    <div id="modal" class="modal">
      <div class="card rounded-2xl p-4 w-[92vw] max-w-md animate-in">
        <h3 id="modalTitle" class="text-lg font-bold mb-3">Ø¥Ø¶Ø§ÙØ©</h3>
        <div class="space-y-3">
          <input id="amount" type="number" inputmode="decimal" class="chip rounded-xl px-3 py-2 w-full bg-transparent" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" />
          <div id="catRow" class="hidden grid grid-cols-2 gap-2">
            <select id="category" class="chip rounded-xl px-3 py-2 bg-transparent">
              <option value="fixed">Ù…ØµØ§Ø±ÙŠÙ Ø«Ø§Ø¨ØªØ©</option>
              <option value="variable">Ù…ØµØ§Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø©</option>
              <option value="savings">Ø§Ø¯Ø®Ø§Ø±</option>
              <option value="personal">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ø®ØµÙŠØ©</option>
            </select>
            <input id="note" class="chip rounded-xl px-3 py-2 bg-transparent" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/>
          </div>
          <div class="flex gap-2 justify-end pt-1">
            <button id="cancel" class="btn rounded-xl px-3 py-2">Ø¥Ù„ØºØ§Ø¡</button>
            <button id="confirm" class="btn rounded-xl px-3 py-2">Ø­ÙØ¸</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-8 text-center text-xs text-muted">
      ÙŠØ¹Ù…Ù„ Ø¹Ø¨Ø± Google Apps Script + GitHub Pages. ÙŠØ¯Ø¹Ù… Ø§Ù„Ø«ÙŠÙ…Ø§ØªØŒ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ¹ØŒ ØªØ¨ÙˆÙŠØ¨Ø§ØªØŒ Pie ØªÙØ§Ø¹Ù„ÙŠØŒ ÙˆØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ.
    </footer>
  </div>

<script>
  // ===== Config =====
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzkG8xYnz4YFiL6Pa5wCXwGXx4p1s3qKtJoTpmotL4XkKys7R9vZxAr6JDqEL-I-vNIog/exec'; // Ø¶Ø¹ Ø±Ø§Ø¨Ø· /exec Ù‡Ù†Ø§
  const AUTO_REFRESH_MS = 25000;

  // ===== Theme =====
  const themeSelect = document.getElementById('themeSelect');
  function applyTheme(name){
    document.body.classList.remove('theme-ocean','theme-mint','theme-neon','theme-rose');
    document.body.classList.add('theme-'+name);
    localStorage.setItem('theme', name);
  }
  applyTheme(localStorage.getItem('theme') || 'ocean');
  themeSelect.value = localStorage.getItem('theme') || 'ocean';
  themeSelect.addEventListener('change', e => applyTheme(e.target.value));

  // ===== Tabs =====
  const tabs = document.querySelectorAll('.tab');
  const sections = {
    overview: document.getElementById('tab-overview'),
    transactions: document.getElementById('tab-transactions'),
    settings: document.getElementById('tab-settings')
  };
  tabs.forEach(btn => btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    Object.values(sections).forEach(sec => sec.classList.add('hidden'));
    sections[btn.dataset.tab].classList.remove('hidden');
  }));

  // ===== Pie =====
  const ctx = document.getElementById('pie');
  let pie;
  function renderPie(byCat){
    const data = [byCat.fixed||0, byCat.variable||0, byCat.savings||0, byCat.personal||0];
    const labels = ['Ø«Ø§Ø¨Øª','Ù…ØªØºÙŠØ±','Ø§Ø¯Ø®Ø§Ø±','Ø§Ù„ØªØ²Ø§Ù…Ø§Øª'];
    if(pie){ pie.destroy(); }
    pie = new Chart(ctx, {
      type: 'pie',
      data: { labels, datasets: [{ data }] },
      options: { responsive: true, plugins: { legend: { position:'bottom' } } }
    });
  }

  // ===== API (POST-only) =====
  async function apiPost(body){
    const res = await fetch(GAS_URL, { method:'POST', body: JSON.stringify(body) });
    return res.json();
  }
  async function apiGet(params = {}){
    return apiPost({ action: params.action || 'summary' });
  }

  // ===== State & UI =====
  const incomeEl = document.getElementById('income');
  const expenseEl = document.getElementById('expense');
  const balanceEl = document.getElementById('balance');
  const cFixed = document.getElementById('c-fixed');
  const cVariable = document.getElementById('c-variable');
  const cSavings = document.getElementById('c-savings');
  const cPersonal = document.getElementById('c-personal');
  const txList = document.getElementById('txList');

  const baseSalary = document.getElementById('baseSalary');
  const alloc_fixed = document.getElementById('alloc_fixed');
  const alloc_variable = document.getElementById('alloc_variable');
  const alloc_savings = document.getElementById('alloc_savings');
  const alloc_personal = document.getElementById('alloc_personal');
  const saveSettings = document.getElementById('saveSettings');
  const applySuggest = document.getElementById('applySuggest');

  function fmt(n){ return Number(n||0).toLocaleString('ar-EG'); }

  async function refresh(){
    const summary = await apiGet({ action:'summary' });
    incomeEl.textContent = fmt(summary.income);
    expenseEl.textContent = fmt(summary.expense);
    balanceEl.textContent = fmt(summary.balance);
    cFixed.textContent = fmt(summary.byCat.fixed);
    cVariable.textContent = fmt(summary.byCat.variable);
    cSavings.textContent = fmt(summary.byCat.savings);
    cPersonal.textContent = fmt(summary.byCat.personal);
    renderPie(summary.byCat);

    baseSalary.value = summary.settings.baseSalary || 0;
    alloc_fixed.value = summary.settings.alloc_fixed || 0;
    alloc_variable.value = summary.settings.alloc_variable || 0;
    alloc_savings.value = summary.settings.alloc_savings || 0;
    alloc_personal.value = summary.settings.alloc_personal || 0;

    const tx = await apiGet({ action:'transactions' });
    txList.innerHTML = tx.data.slice().reverse().map(t => `
      <div class="flex items-center justify-between chip rounded-xl px-3 py-2">
        <div class="flex items-center gap-2">
          <span class="text-xs opacity-70">${new Date(t.timestamp).toLocaleString('ar-EG')}</span>
          <span class="text-xs">${t.category}</span>
          <span class="text-xs opacity-70">${t.note||''}</span>
        </div>
        <b class="${t.type==='income'?'text-ok':'text-bad'}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</b>
      </div>
    `).join('');
  }

  let timer = setInterval(refresh, AUTO_REFRESH_MS);
  document.getElementById('refreshBtn').addEventListener('click', () => {
    clearInterval(timer); refresh(); timer=setInterval(refresh, AUTO_REFRESH_MS);
  });

  // ===== Modal (Quick Add) =====
  const modal = document.getElementById('modal');
  const catRow = document.getElementById('catRow');
  const modalTitle = document.getElementById('modalTitle');
  const amount = document.getElementById('amount');
  const category = document.getElementById('category');
  const note = document.getElementById('note');
  const confirmBtn = document.getElementById('confirm');
  const cancel = document.getElementById('cancel');

  let modalMode = 'income';
  function openModal(mode){
    modalMode = mode;
    modal.classList.add('active');
    amount.value = ''; note.value = '';
    if(mode === 'expense'){
      catRow.classList.remove('hidden');
      modalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ';
    } else {
      catRow.classList.add('hidden');
      modalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¯Ø®Ù„/Ø±Ø§ØªØ¨';
    }
    setTimeout(()=> amount.focus(), 60);
  }
  function closeModal(){ modal.classList.remove('active'); }

  document.getElementById('addIncome').addEventListener('click', ()=> openModal('income'));
  document.getElementById('addExpense').addEventListener('click', ()=> openModal('expense'));
  cancel.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=> { if(e.target===modal) closeModal(); });

  confirmBtn.addEventListener('click', async ()=>{
    const val = Number(amount.value||0);
    if(!val || val<=0) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }
    try {
      if(modalMode==='income'){
        await apiPost({ action:'addTransaction', type:'income', category:'fixed', amount:val, note: note.value });
      } else {
        await apiPost({ action:'addTransaction', type:'expense', category: category.value, amount:val, note: note.value });
      }
    } finally {
      closeModal(); // ÙŠØºÙ„Ù‚ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„
      refresh();
    }
  });

  // ===== Settings =====
  saveSettings.addEventListener('click', async ()=>{
    await apiPost({
      action:'saveSettings',
      baseSalary: Number(baseSalary.value||0),
      alloc_fixed: Number(alloc_fixed.value||0),
      alloc_variable: Number(alloc_variable.value||0),
      alloc_savings: Number(alloc_savings.value||0),
      alloc_personal: Number(alloc_personal.value||0)
    });
    refresh();
  });

  function suggestAllocation(salary){
    const s = Number(salary||0);
    let fixed = 45, variable = 30, savings = 20, personal = 5;
    if(s > 0 && s < 3000){ fixed = 50; variable = 28; savings = 17; personal = 5; }
    else if(s >= 3000 && s < 7000){ fixed = 47; variable = 28; savings = 20; personal = 5; }
    else if(s >= 7000){ fixed = 45; variable = 28; savings = 22; personal = 5; }
    return { fixed, variable, savings, personal };
  }

  document.getElementById('applySuggest').addEventListener('click', async ()=>{
    const s = Number(baseSalary.value||0);
    const sug = suggestAllocation(s);
    alloc_fixed.value = sug.fixed;
    alloc_variable.value = sug.variable;
    alloc_savings.value = sug.savings;
    alloc_personal.value = sug.personal;
    if(window.confirm('ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‚ØªØ±Ø­ ÙˆØ­ÙØ¸Ù‡ØŸ')){
      await apiPost({ action:'applySuggestedAlloc', baseSalary:s, suggestion:{ fixed:sug.fixed, variable:sug.variable, savings:sug.savings, personal:sug.personal } });
      refresh();
    }
  });

  // Start
  refresh();
</script>
  <script src="app.extra.js"></script>
  <script src="app.features.js"></script>
</body>
</html>
