/** Google Apps Script backend for "مصروفاتي" **/

const SHEET_TRANSACTIONS = 'transactions';
const SHEET_SETTINGS = 'settings';

function _sheet(name){
  const ss = SpreadsheetApp.getActive();
  let sh = ss.getSheetByName(name);
  if(!sh){
    sh = ss.insertSheet(name);
  }
  return sh;
}

// تأكيد السكيمة والهيدر رو إذا مفقودة
function setup_(){
  const tx = _sheet(SHEET_TRANSACTIONS);
  if(tx.getLastRow() === 0){
    tx.getRange(1,1,1,5).setValues([['timestamp','type','category','amount','note']]);
  } else {
    // تأكد أن أول صف هو هيدر
    const first = tx.getRange(1,1,1,5).getValues()[0];
    if(String(first[0]).toLowerCase() !== 'timestamp'){
      tx.insertRowBefore(1);
      tx.getRange(1,1,1,5).setValues([['timestamp','type','category','amount','note']]);
    }
  }

  const st = _sheet(SHEET_SETTINGS);
  if(st.getLastRow() === 0){
    st.getRange(1,1,1,5).setValues([[0,0,0,0,0]]);
  }
}

function _applyCors(resp){
  return resp
    .setHeader('Access-Control-Allow-Origin', '*')
    .setHeader('Access-Control-Allow-Methods', 'GET,POST')
    .setHeader('Access-Control-Allow-Headers', 'Content-Type');
}

function doGet(e){
  setup_();

  const action = (e && e.parameter && e.parameter.action) || 'summary';
  let res = {};
  try {
    if(action === 'summary'){
      res = getSummary_();
    } else if(action === 'transactions'){
      res = getTransactions_();
    } else if(action === 'settings'){
      res = getSettings_();
    } else {
      res = { error: 'Unknown action' };
    }
  } catch(err){
    res = { ok:false, error: String(err) };
  }

  const out = ContentService.createTextOutput(JSON.stringify(res))
    .setMimeType(ContentService.MimeType.JSON);
  return _applyCors(out);
}

function doPost(e){
  setup_();

  let body = {};
  try {
    body = JSON.parse(e.postData && e.postData.contents || '{}');
  } catch(_){ body = {}; }

  const headers = ContentService.createTextOutput()
    .setMimeType(ContentService.MimeType.JSON);

  try {
    const { action } = body;

    if(action === 'addTransaction'){
      const { type, category, amount, note } = body;
      if(!type || !category || amount == null) throw new Error('Missing fields');
      const sh = _sheet(SHEET_TRANSACTIONS);
      sh.appendRow([ new Date(), String(type), String(category), Number(amount), String(note||'') ]);
      const out = ContentService.createTextOutput(JSON.stringify({ ok:true }))
        .setMimeType(ContentService.MimeType.JSON);
      return _applyCors(out);
    }

    if(action === 'saveSettings'){
      const { baseSalary, alloc_fixed, alloc_variable, alloc_savings, alloc_personal } = body;
      const sh = _sheet(SHEET_SETTINGS);
      if(sh.getLastRow() === 0){ sh.getRange(1,1,1,5).setValues([[0,0,0,0,0]]); }
      sh.getRange(1,1,1,5).setValues([[
        Number(baseSalary||0),
        Number(alloc_fixed||0),
        Number(alloc_variable||0),
        Number(alloc_savings||0),
        Number(alloc_personal||0)
      ]]);
      const out = ContentService.createTextOutput(JSON.stringify({ ok:true }))
        .setMimeType(ContentService.MimeType.JSON);
      return _applyCors(out);
    }

    if(action === 'applySuggestedAlloc'){
      const { baseSalary, suggestion } = body; // {fixed, variable, savings, personal}
      const sh = _sheet(SHEET_SETTINGS);
      if(sh.getLastRow() === 0){ sh.getRange(1,1,1,5).setValues([[0,0,0,0,0]]); }
      sh.getRange(1,1,1,5).setValues([[
        Number(baseSalary||0),
        Number(suggestion?.fixed||0),
        Number(suggestion?.variable||0),
        Number(suggestion?.savings||0),
        Number(suggestion?.personal||0)
      ]]);
      const out = ContentService.createTextOutput(JSON.stringify({ ok:true }))
        .setMimeType(ContentService.MimeType.JSON);
      return _applyCors(out);
    }

    const out = ContentService.createTextOutput(JSON.stringify({ ok:false, error:'Unknown action' }))
      .setMimeType(ContentService.MimeType.JSON);
    return _applyCors(out);

  } catch(err){
    const out = ContentService.createTextOutput(JSON.stringify({ ok:false, error:String(err) }))
      .setMimeType(ContentService.MimeType.JSON);
    return _applyCors(out);
  }
}

function getTransactions_(){
  const sh = _sheet(SHEET_TRANSACTIONS);
  const rows = sh.getDataRange().getValues();
  rows.shift(); // remove header
  const data = rows.map(r => ({
    timestamp: r[0],
    type: r[1],
    category: r[2],
    amount: r[3],
    note: r[4]
  }));
  return { headers: ['timestamp','type','category','amount','note'], data };
}

function getSettings_(){
  const sh = _sheet(SHEET_SETTINGS);
  const v = sh.getRange(1,1,1,5).getValues()[0];
  return {
    baseSalary: Number(v[0]||0),
    alloc_fixed: Number(v[1]||0),
    alloc_variable: Number(v[2]||0),
    alloc_savings: Number(v[3]||0),
    alloc_personal: Number(v[4]||0),
  };
}

function getSummary_(){
  const tx = getTransactions_().data;
  const st = getSettings_();
  let income = 0, expense = 0;
  const byCat = { fixed:0, variable:0, savings:0, personal:0 };

  tx.forEach(t => {
    if(t.type === 'income') income += Number(t.amount||0);
    else if(t.type === 'expense'){
      expense += Number(t.amount||0);
      if(byCat[t.category] != null) byCat[t.category] += Number(t.amount||0);
    }
  });

  const balance = income - expense;
  return { income, expense, balance, byCat, settings: st };
}
